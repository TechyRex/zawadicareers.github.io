<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Blog - Zawadi Careers Admin</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" href="../assets/zawadi-logo.png" type="image/png">
</head>
<body class="admin-body">
    <!-- Admin Header -->
    <header class="admin-header">
        <nav class="admin-nav">
            <div class="admin-logo">
                <img src="../assets/zawadi-logo.png" alt="Zawadi Careers Logo" height="32">
                <span class="logo-text">Blog Editor</span>
            </div>

            <div class="admin-actions">
                <button onclick="saveAsDraft()" class="btn btn-outline">Save Draft</button>
                <button onclick="previewBlog()" class="btn btn-outline">
                    <i class="fas fa-eye"></i> Preview
                </button>
                <button onclick="publishBlog()" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Publish
                </button>
            </div>
        </nav>
    </header>

    <div class="admin-container">
        <!-- Main Editor -->
        <main class="admin-main">
            <div class="editor-container">
                <!-- Basic Information -->
                <div class="editor-section">
                    <h2>Basic Information</h2>
                    
                    <div class="form-group">
                        <label for="blogTitle" class="form-label">Blog Title *</label>
                        <input type="text" id="blogTitle" class="form-control form-control-lg" 
                               placeholder="Enter a compelling title for your blog post" required>
                    </div>

                    <div class="form-group">
                        <label for="blogSlug" class="form-label">URL Slug *</label>
                        <div class="slug-input-group">
                            <span class="slug-prefix">zawadicareers.com/blog/</span>
                            <input type="text" id="blogSlug" class="form-control" 
                                   placeholder="blog-url-slug" required>
                        </div>
                        <small class="form-text">Used for the blog URL. Use lowercase letters, numbers, and hyphens only.</small>
                    </div>

                    <div class="form-group">
                        <label for="blogExcerpt" class="form-label">Excerpt</label>
                        <textarea id="blogExcerpt" class="form-control" rows="3" 
                                  placeholder="Brief summary of the blog post (shown in listings)"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="blogCategory" class="form-label">Category *</label>
                            <select id="blogCategory" class="form-control" required>
                                <option value="">Select a category</option>
                                <!-- Categories loaded dynamically -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="readingTime" class="form-label">Reading Time (minutes)</label>
                            <input type="number" id="readingTime" class="form-control" min="1" value="5">
                        </div>
                    </div>
                </div>

                <!-- Cover Image -->
                <div class="editor-section">
                    <h2>Cover Image</h2>
                    
                    <div class="image-upload" id="coverImageUpload">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <p>Drag & drop your cover image here, or click to browse</p>
                        <p class="upload-hint">Recommended: 1200Ã—630px, JPG or PNG, max 2MB</p>
                        <input type="file" id="coverImageFile" accept="image/*" style="display: none;">
                    </div>

                    <div class="image-preview" id="coverImagePreview" style="display: none;">
                        <img src="" alt="Cover Preview" id="coverPreviewImage">
                        <button onclick="removeCoverImage()" class="btn btn-outline btn-sm">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                </div>

                <!-- Blog Sections -->
                <div class="editor-section">
                    <div class="section-header">
                        <h2>Blog Content Sections</h2>
                        <button onclick="addNewSection()" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Section
                        </button>
                    </div>

                    <div class="sections-container" id="sectionsContainer">
                        <!-- Sections added here -->
                    </div>
                </div>

                <!-- SEO & Meta -->
                <div class="editor-section">
                    <h2>SEO Settings</h2>
                    
                    <div class="form-group">
                        <label for="metaTitle" class="form-label">Meta Title</label>
                        <input type="text" id="metaTitle" class="form-control" 
                               placeholder="Title for search engines (defaults to blog title)">
                    </div>

                    <div class="form-group">
                        <label for="metaDescription" class="form-label">Meta Description</label>
                        <textarea id="metaDescription" class="form-control" rows="3" 
                                  placeholder="Description for search engines (max 160 characters)"></textarea>
                    </div>
                </div>

                <!-- Status & Publishing -->
                <div class="editor-section">
                    <div class="form-group">
                        <label for="blogStatus" class="form-label">Status</label>
                        <select id="blogStatus" class="form-control">
                            <option value="draft">Draft</option>
                            <option value="published">Published</option>
                        </select>
                    </div>

                    <div class="editor-actions">
                        <button onclick="saveAsDraft()" class="btn btn-outline btn-large">
                            <i class="fas fa-save"></i> Save Draft
                        </button>
                        <button onclick="publishBlog()" class="btn btn-primary btn-large">
                            <i class="fas fa-paper-plane"></i> Publish Now
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Section Template (Hidden) -->
    <template id="sectionTemplate">
        <div class="section-editor" data-section-id="">
            <div class="section-header">
                <span class="section-order">Section 1</span>
                <button type="button" class="remove-section" onclick="removeSection(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>

            <div class="section-type-selector">
                <button type="button" class="type-btn active" data-type="text">
                    <i class="fas fa-paragraph"></i>
                    <span>Text</span>
                </button>
                <button type="button" class="type-btn" data-type="image">
                    <i class="fas fa-image"></i>
                    <span>Image</span>
                </button>
                <button type="button" class="type-btn" data-type="video">
                    <i class="fas fa-video"></i>
                    <span>Video</span>
                </button>
            </div>

            <!-- Text Editor -->
            <div class="section-content text-content" style="display: block;">
                <div class="form-group">
                    <label class="form-label">Section Title (Optional)</label>
                    <input type="text" class="form-control section-title" placeholder="Section heading">
                </div>
                <div class="form-group">
                    <label class="form-label">Content</label>
                    <textarea class="form-control section-text" rows="6" 
                              placeholder="Write your content here..."></textarea>
                </div>
            </div>

            <!-- Image Upload -->
            <div class="section-content image-content" style="display: none;">
                <div class="image-upload section-image-upload">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Upload an image for this section</p>
                    <input type="file" class="section-image-file" accept="image/*" style="display: none;">
                </div>
                <div class="form-group">
                    <label class="form-label">Image Caption</label>
                    <input type="text" class="form-control section-caption" 
                           placeholder="Brief caption for the image">
                </div>
            </div>

            <!-- Video Embed -->
            <div class="section-content video-content" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Video URL</label>
                    <input type="url" class="form-control section-video-url" 
                           placeholder="https://youtube.com/watch?v=... or video embed URL">
                </div>
                <div class="form-group">
                    <label class="form-label">Video Caption</label>
                    <input type="text" class="form-control section-caption" 
                           placeholder="Brief caption for the video">
                </div>
            </div>
        </div>
    </template>

    <script src="../js/supabase.js"></script>
    <script src="../js/editor.js"></script>
    <script>
        let sections = [];
        let coverImageUrl = '';

        // Initialize editor
        document.addEventListener('DOMContentLoaded', async () => {
            // Check admin authentication
            const isAdmin = await ZawadiAPI.isAdmin();
            if (!isAdmin) {
                window.location.href = 'admin-login.html';
                return;
            }

            // Load categories
            await loadCategories();
            
            // Generate slug from title
            document.getElementById('blogTitle').addEventListener('input', generateSlug);
            
            // Setup image upload
            setupImageUpload();
            
            // Add first section
            addNewSection();
        });

        async function loadCategories() {
            const { success, data } = await ZawadiAPI.getCategories();
            if (success) {
                const select = document.getElementById('blogCategory');
                select.innerHTML = '<option value="">Select a category</option>' +
                    data.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            }
        }

        function generateSlug() {
            const title = document.getElementById('blogTitle').value;
            const slugInput = document.getElementById('blogSlug');
            
            if (title && (!slugInput.value || slugInput.value === slugify(title))) {
                slugInput.value = slugify(title);
            }
        }

        function slugify(text) {
            return text
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function setupImageUpload() {
            const uploadArea = document.getElementById('coverImageUpload');
            const fileInput = document.getElementById('coverImageFile');
            const preview = document.getElementById('coverImagePreview');
            const previewImg = document.getElementById('coverPreviewImage');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary-color)';
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '';
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files[0]);
                }
            });

            async function handleImageUpload(file) {
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    return;
                }

                if (file.size > 2 * 1024 * 1024) {
                    alert('Image size should be less than 2MB');
                    return;
                }

                try {
                    const { success, url, error } = await ZawadiAPI.uploadImage(file, 'blog-covers');
                    
                    if (success) {
                        coverImageUrl = url;
                        previewImg.src = url;
                        uploadArea.style.display = 'none';
                        preview.style.display = 'block';
                    } else {
                        alert(error || 'Failed to upload image');
                    }
                } catch (error) {
                    alert('Error uploading image: ' + error.message);
                }
            }
        }

        function removeCoverImage() {
            coverImageUrl = '';
            document.getElementById('coverImageUpload').style.display = 'block';
            document.getElementById('coverImagePreview').style.display = 'none';
        }

        function addNewSection() {
            const template = document.getElementById('sectionTemplate');
            const clone = template.content.cloneNode(true);
            const sectionElement = clone.querySelector('.section-editor');
            
            // Set section number
            const sectionCount = sections.length + 1;
            sectionElement.querySelector('.section-order').textContent = `Section ${sectionCount}`;
            sectionElement.dataset.sectionId = Date.now();
            
            // Add to container
            document.getElementById('sectionsContainer').appendChild(sectionElement);
            
            // Setup type buttons
            setupSectionTypeButtons(sectionElement);
            
            // Add to sections array
            sections.push({
                id: sectionElement.dataset.sectionId,
                type: 'text',
                title: '',
                content: '',
                media_url: '',
                media_caption: ''
            });
        }

        function setupSectionTypeButtons(sectionElement) {
            const typeBtns = sectionElement.querySelectorAll('.type-btn');
            const contentDivs = sectionElement.querySelectorAll('.section-content');
            
            typeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all buttons
                    typeBtns.forEach(b => b.classList.remove('active'));
                    // Hide all content divs
                    contentDivs.forEach(div => div.style.display = 'none');
                    
                    // Activate clicked button
                    btn.classList.add('active');
                    const type = btn.dataset.type;
                    
                    // Show corresponding content
                    const contentDiv = sectionElement.querySelector(`.${type}-content`);
                    if (contentDiv) {
                        contentDiv.style.display = 'block';
                    }
                    
                    // Update sections array
                    const sectionId = sectionElement.dataset.sectionId;
                    const sectionIndex = sections.findIndex(s => s.id === sectionId);
                    if (sectionIndex !== -1) {
                        sections[sectionIndex].type = type;
                    }
                });
            });
        }

        function removeSection(button) {
            const sectionElement = button.closest('.section-editor');
            const sectionId = sectionElement.dataset.sectionId;
            
            // Remove from array
            const index = sections.findIndex(s => s.id === sectionId);
            if (index !== -1) {
                sections.splice(index, 1);
            }
            
            // Remove from DOM
            sectionElement.remove();
            
            // Update section numbers
            updateSectionNumbers();
        }

        function updateSectionNumbers() {
            const sections = document.querySelectorAll('.section-editor');
            sections.forEach((section, index) => {
                section.querySelector('.section-order').textContent = `Section ${index + 1}`;
            });
        }

        async function saveBlog(status = 'draft') {
            // Collect form data
            const title = document.getElementById('blogTitle').value.trim();
            const slug = document.getElementById('blogSlug').value.trim();
            const excerpt = document.getElementById('blogExcerpt').value.trim();
            const categoryId = document.getElementById('blogCategory').value;
            const readingTime = parseInt(document.getElementById('readingTime').value) || 5;
            const metaTitle = document.getElementById('metaTitle').value.trim();
            const metaDescription = document.getElementById('metaDescription').value.trim();
            
            if (!title || !slug || !categoryId) {
                alert('Please fill in all required fields');
                return false;
            }

            // Collect section data
            const sectionElements = document.querySelectorAll('.section-editor');
            const blogSections = [];
            
            sectionElements.forEach((sectionElement, index) => {
                const type = sectionElement.querySelector('.type-btn.active').dataset.type;
                const title = sectionElement.querySelector('.section-title')?.value.trim() || '';
                const content = sectionElement.querySelector('.section-text')?.value.trim() || 
                               sectionElement.querySelector('.section-video-url')?.value.trim() || '';
                const caption = sectionElement.querySelector('.section-caption')?.value.trim() || '';
                
                blogSections.push({
                    section_order: index + 1,
                    title,
                    content,
                    content_type: type,
                    media_url: type !== 'text' ? content : null,
                    media_caption: caption
                });
            });

            if (blogSections.length === 0) {
                alert('Please add at least one section to the blog');
                return false;
            }

            const blogData = {
                title,
                slug,
                excerpt,
                category_id: categoryId,
                cover_image: coverImageUrl,
                reading_time: readingTime,
                status,
                meta_title: metaTitle || title,
                meta_description: metaDescription || excerpt
            };

            try {
                const { success, error } = await ZawadiAPI.createBlog(blogData, blogSections);
                
                if (success) {
                    showNotification(`Blog ${status === 'draft' ? 'saved as draft' : 'published successfully'}!`, 'success');
                    return true;
                } else {
                    showNotification(error || `Failed to ${status === 'draft' ? 'save' : 'publish'} blog`, 'error');
                    return false;
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
                return false;
            }
        }

        async function saveAsDraft() {
            return await saveBlog('draft');
        }

        async function publishBlog() {
            const confirmed = confirm('Are you sure you want to publish this blog? It will be visible to all users.');
            if (confirmed) {
                const success = await saveBlog('published');
                if (success) {
                    setTimeout(() => {
                        window.location.href = 'admin-dashboard.html';
                    }, 1500);
                }
            }
        }

        function previewBlog() {
            alert('Preview feature will open in a new tab. Currently in development.');
            // In production, this would generate a preview URL
        }

        function showNotification(message, type) {
            // Simple notification for editor
            const notification = document.createElement('div');
            notification.className = `editor-notification editor-notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add notification styles
        const notificationStyles = document.createElement('style');
        notificationStyles.textContent = `
            .editor-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                padding: var(--spacing-md) var(--spacing-lg);
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                display: flex;
                align-items: center;
                gap: var(--spacing-md);
                z-index: 9999;
                animation: slideIn 0.3s ease;
                border-left: 4px solid var(--primary-color);
            }
            
            .editor-notification-success {
                border-left-color: var(--success-color);
            }
            
            .editor-notification-error {
                border-left-color: var(--error-color);
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(notificationStyles);
    </script>
</body>
</html>
