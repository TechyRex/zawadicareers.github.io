<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Zawadi Careers</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" href="../assets/zawadi-logo.png" type="image/png">
</head>
<body class="admin-body">
    <!-- Admin Header -->
    <header class="admin-header">
        <nav class="admin-nav">
            <div class="admin-logo">
                <img src="../assets/zawadi-logo.png" alt="Zawadi Careers Logo" height="32">
                <span class="logo-text">Admin</span>
            </div>

            <div class="admin-user" id="adminUserInfo">
                <!-- Filled by JavaScript -->
            </div>
        </nav>
    </header>

    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <nav class="sidebar-menu">
                <a href="admin-dashboard.html" class="menu-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="admin-blog-editor.html" class="menu-item">
                    <i class="fas fa-edit"></i>
                    <span>Create Blog</span>
                </a>
                <a href="admin-blogs.html" class="menu-item">
                    <i class="fas fa-newspaper"></i>
                    <span>Manage Blogs</span>
                </a>
                <a href="admin-categories.html" class="menu-item">
                    <i class="fas fa-folder"></i>
                    <span>Categories</span>
                </a>
                <a href="admin-comments.html" class="menu-item">
                    <i class="fas fa-comments"></i>
                    <span>Comments</span>
                    <span class="badge" id="pendingComments">0</span>
                </a>
                <a href="admin-analytics.html" class="menu-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
                <a href="admin-subscribers.html" class="menu-item">
                    <i class="fas fa-users"></i>
                    <span>Subscribers</span>
                </a>
                <a href="admin-settings.html" class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <button onclick="handleAdminSignOut()" class="menu-item">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sign Out</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="dashboard-header">
                <h1>Dashboard Overview</h1>
                <div class="time-range-selector">
                    <select id="timeRange" class="form-control">
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d" selected>Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                        <option value="90d">Last 90 Days</option>
                    </select>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid" id="statsGrid">
                <!-- Filled by JavaScript -->
            </div>

            <!-- Recent Activities -->
            <div class="card">
                <div class="card-header">
                    <h2>Recent Activities</h2>
                    <a href="admin-analytics.html" class="btn btn-outline btn-sm">View All</a>
                </div>
                <div class="card-body">
                    <div class="activities-list" id="activitiesList">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2>Quick Actions</h2>
                <div class="actions-grid">
                    <a href="admin-blog-editor.html" class="action-card">
                        <i class="fas fa-plus-circle"></i>
                        <h3>New Blog Post</h3>
                        <p>Create a new career insight article</p>
                    </a>
                    <a href="admin-categories.html" class="action-card">
                        <i class="fas fa-folder-plus"></i>
                        <h3>Add Category</h3>
                        <p>Create new blog category</p>
                    </a>
                    <a href="admin-comments.html" class="action-card">
                        <i class="fas fa-comment-medical"></i>
                        <h3>Moderate Comments</h3>
                        <p>Review new comments</p>
                    </a>
                    <a href="admin-analytics.html" class="action-card">
                        <i class="fas fa-chart-line"></i>
                        <h3>View Reports</h3>
                        <p>Detailed analytics</p>
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/supabase.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        // Check admin authentication
        async function checkAdminAuth() {
            const isAdmin = await ZawadiAPI.isAdmin();
            if (!isAdmin) {
                window.location.href = 'admin-login.html';
                return;
            }

            // Load admin user info
            loadAdminInfo();
            // Load dashboard data
            loadDashboardData();
        }

        async function loadAdminInfo() {
            const { data: { user } } = await ZawadiAPI.supabase.auth.getUser();
            if (user) {
                const adminUserInfo = document.getElementById('adminUserInfo');
                const initials = user.email.substring(0, 2).toUpperCase();
                adminUserInfo.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${initials}</div>
                        <div>
                            <div class="user-name">${user.email}</div>
                            <div class="user-role">Administrator</div>
                        </div>
                    </div>
                `;
            }
        }

        async function loadDashboardData() {
            const timeRange = document.getElementById('timeRange').value;
            
            // Load analytics
            const { success: analyticsSuccess, data: analyticsData } = await ZawadiAPI.getDashboardAnalytics(timeRange);
            
            if (analyticsSuccess) {
                updateStatsGrid(analyticsData);
            }

            // Load recent activities
            const { success: activitiesSuccess, data: activities } = await ZawadiAPI.getRecentActivities(10);
            
            if (activitiesSuccess) {
                updateActivitiesList(activities);
            }

            // Load pending comments count
            loadPendingCommentsCount();
        }

        function updateStatsGrid(data) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon primary">
                            <i class="fas fa-newspaper"></i>
                        </div>
                        <div class="stat-change positive">+12%</div>
                    </div>
                    <div class="stat-value">${data.totalBlogs || 0}</div>
                    <div class="stat-label">Total Articles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon success">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="stat-change positive">+24%</div>
                    </div>
                    <div class="stat-value">${data.totalViews || 0}</div>
                    <div class="stat-label">Total Views (${data.timeRange})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon warning">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-change positive">+8%</div>
                    </div>
                    <div class="stat-value">${data.totalUsers || 0}</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon info">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="stat-change positive">+15%</div>
                    </div>
                    <div class="stat-value">${data.newSubscribers || 0}</div>
                    <div class="stat-label">New Subscribers (${data.timeRange})</div>
                </div>
            `;
        }

        function updateActivitiesList(activities) {
            const activitiesList = document.getElementById('activitiesList');
            
            if (!activities || activities.length === 0) {
                activitiesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <p>No recent activities</p>
                    </div>
                `;
                return;
            }

            activitiesList.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas fa-${getActivityIcon(activity.event_type)}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${getActivityTitle(activity)}</div>
                        <div class="activity-time">${formatTimeAgo(activity.created_at)}</div>
                    </div>
                </div>
            `).join('');
        }

        function getActivityIcon(eventType) {
            const icons = {
                'page_view': 'eye',
                'blog_view': 'newspaper',
                'like': 'heart',
                'comment': 'comment',
                'signup': 'user-plus',
                'subscription': 'envelope'
            };
            return icons[eventType] || 'circle';
        }

        function getActivityTitle(activity) {
            const user = activity.users?.full_name || 'A user';
            const blog = activity.blogs?.title || '';
            
            switch (activity.event_type) {
                case 'page_view':
                    return `${user} viewed ${blog || 'a page'}`;
                case 'blog_view':
                    return `${user} read "${blog}"`;
                case 'like':
                    return `${user} liked "${blog}"`;
                case 'comment':
                    return `${user} commented on "${blog}"`;
                case 'signup':
                    return `${user} joined Zawadi Careers`;
                case 'subscription':
                    return `${user} subscribed to newsletter`;
                default:
                    return 'New activity';
            }
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString();
        }

        async function loadPendingCommentsCount() {
            const { count } = await ZawadiAPI.supabase
                .from('comments')
                .select('*', { count: 'exact', head: true })
                .eq('is_approved', false);

            const badge = document.getElementById('pendingComments');
            if (badge && count) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            }
        }

        async function handleAdminSignOut() {
            await ZawadiAPI.signOut();
            window.location.href = 'admin-login.html';
        }

        // Time range change
        document.getElementById('timeRange').addEventListener('change', loadDashboardData);

        // Initialize dashboard
        checkAdminAuth();
    </script>
</body>
</html>
